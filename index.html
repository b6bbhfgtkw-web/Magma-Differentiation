<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Magma Differentiation Visualizer — Fractional Crystallization</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#101b33; --text:#e6edf7; --muted:#9fb0cc;
      --border:#22304f; --btn:#1b2b52; --btnb:#2a3d73;
    }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }
    header{ padding:16px 20px; border-bottom:1px solid var(--border); background:linear-gradient(90deg,#0b1220,#0f1a35); }
    header h1{ margin:0; font-size:18px; font-weight:700; }
    header p{ margin:6px 0 0; color:var(--muted); font-size:13px; max-width:1200px; line-height:1.35; }
    .wrap{ display:grid; grid-template-columns: 420px 1fr; gap:14px; padding:14px; }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px; }
    .controls{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    button{ background:var(--btn); border:1px solid var(--btnb); color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:650; }
    button:hover{ border-color:#3f61b3; }
    button:disabled{ opacity:.45; cursor:not-allowed; }
    input[type="range"]{ width:100%; }
    input[type="number"]{ width:86px; background:#0c1630; color:var(--text); border:1px solid var(--btnb); border-radius:10px; padding:6px 8px; }
    .muted{ color:var(--muted); }
    .kpi{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
    .kpi div{ background:#0c1630; border:1px solid var(--border); border-radius:10px; padding:10px; }
    .kpi .v{ font-size:18px; font-weight:800; margin-top:4px; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .gridCharts{ display:grid; grid-template-columns: repeat(2, minmax(260px, 1fr)); gap:12px; }
    canvas{ background:#0c1630; border:1px solid var(--border); border-radius:10px; }
    table{ width:100%; border-collapse:collapse; font-size:12px; }
    th, td{ border-bottom:1px solid var(--border); padding:6px 6px; text-align:right; }
    th:first-child, td:first-child{ text-align:left; }
    .note{ font-size:12px; color:var(--muted); line-height:1.35; margin:8px 0 0; }
    .warn{ background:#2a0f1a; border:1px solid #6b2438; padding:10px; border-radius:10px; color:#ffd1dc; font-size:12px; margin-top:12px; display:none; }
    .pill{ display:inline-block; padding:2px 8px; border:1px solid var(--border); border-radius:999px; color:var(--muted); font-size:12px; margin-left:8px; }
    .minihead{ display:flex; justify-content:space-between; align-items:baseline; gap:10px; }
    .minihead h3{ margin:0; font-size:14px; }
    .subtle{ font-size:12px; color:var(--muted); }

    /* Responsive pie container */
    .pieWrap{ display:flex; justify-content:center; }
    .pieBox{ position:relative; width:min(320px, 100%); height:clamp(140px, 22vw, 220px); margin:0 auto; }

    /* Magma visualizer */
    .magmaBox{ background:#0c1630; border:1px solid var(--border); border-radius:10px; padding:10px; }
    .bar{ display:flex; height:22px; border-radius:10px; overflow:hidden; border:1px solid #22304f; background:#0b1220; }
    .seg{ height:100%; position:relative; }
    .seg:hover{ filter:brightness(1.1); }
    .legend{ display:grid; grid-template-columns: repeat(2, minmax(180px, 1fr)); gap:6px 10px; margin-top:10px; }
    .legitem{ display:flex; align-items:center; gap:8px; font-size:12px; color:var(--muted); }
    .swatch{ width:12px; height:12px; border-radius:3px; border:1px solid #22304f; }
    .tiny{ font-size:11px; }
  </style>
</head>
<body>
<header>
  <h1>Magma Differentiation Visualizer <span class="pill">Fractional crystallization • 10 steps</span></h1>
  <p>
    Jump-ahead is disabled (students must advance step-by-step). Crystallization is limited by element availability (no negative cations; no >100% artifacts). Per-cation charts use a fixed y-axis of 0–50%.
  </p>
</header>

<div class="wrap">
  <div class="card">
    <div class="controls">
      <button id="btnPrev">⟵ Prev</button>
      <button id="btnNext">Next ⟶</button>
      <button id="btnResetStep">Reset Step</button>
    </div>

    <div style="margin-top:10px;">
      <div class="muted" style="display:flex; justify-content:space-between; align-items:center;">
        <span>Crystallization step: <b id="stepLabel">0</b></span>
        <span>Fraction liquid (F): <b id="fLabel">1.000</b></span>
      </div>
      <input id="stepSlider" type="range" min="0" max="0" step="1" value="0" />
      <div class="note">You can slide backward to review, but you cannot jump ahead of the furthest step you’ve reached.</div>
    </div>

    <div class="kpi">
      <div>
        <div class="muted">Total cations in melt</div>
        <div class="v" id="totalCations">—</div>
      </div>
      <div>
        <div class="muted">Mg# = Mg/(Mg+Fe)</div>
        <div class="v" id="mgNum">—</div>
      </div>
    </div>

    <h3 style="margin:14px 0 8px; font-size:14px;">Initial melt cations (editable)</h3>
    <div class="note">Change values and click <b>Apply</b>. If any element runs out, minerals in that step are partially crystallized (limited by the limiting element).</div>
    <div style="margin-top:8px;">
      <table id="tblInit">
        <thead><tr><th>Element</th><th>Count</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="controls" style="margin-top:8px;">
        <button id="btnApplyInit">Apply</button>
        <button id="btnResetInit">Reset Initial</button>
      </div>
    </div>

    <h3 style="margin:14px 0 8px; font-size:14px;">Minerals crystallized this step</h3>
    <div class="note">Shows <b>actual</b> crystallization (after limiting) vs the requested schedule.</div>
    <div style="margin-top:8px; max-height:210px; overflow:auto;">
      <table id="tblRemoved">
        <thead><tr><th>Mineral</th><th>Actual</th><th class="muted">Requested</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <h3 style="margin:14px 0 8px; font-size:14px;">Melt composition (current step)</h3>
    <div class="grid2">
      <div>
        <div class="muted" style="margin-bottom:6px;">Cations remaining (counts)</div>
        <div style="max-height:210px; overflow:auto;">
          <table id="tblCounts"><thead><tr><th>Element</th><th>Count</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px;">Melt composition (cation %)</div>
        <div style="max-height:210px; overflow:auto;">
          <table id="tblPct"><thead><tr><th>Element</th><th>%</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>

    <div id="warnBox" class="warn"></div>
  </div>

  <div class="card">
    <div class="minihead">
      <h3>Magma visualizer (total magma partition)</h3>
      <div class="subtle">Melt + cumulative crystals (relative area = % of total)</div>
    </div>
    <div class="magmaBox">
      <div class="bar" id="magmaBar" aria-label="magma bar"></div>
      <div class="legend" id="magmaLegend"></div>
      <div class="note tiny">Percentages are based on <b>cation totals</b>: remaining melt cations + cations locked into each mineral so far (sum = 100%).</div>
    </div>

    <div style="margin-top:14px;" class="minihead">
      <h3>Normalized mineral modes (pie) — current step</h3>
      <div class="subtle">ol / pyx / plag / alk / qtz</div>
    </div>
    <div class="pieWrap"><div class="pieBox"><canvas id="chartPie"></canvas></div></div>

    <div style="margin-top:14px;" class="minihead">
      <h3>Per-cation trends: melt % vs crystallized each step</h3>
      <div class="subtle">Incremental plotting • y-axis fixed 0–50%</div>
    </div>
    <div class="gridCharts" style="margin-top:8px;">
      <div><canvas id="c_Si" height="200"></canvas></div>
      <div><canvas id="c_Al" height="200"></canvas></div>
      <div><canvas id="c_Mg" height="200"></canvas></div>
      <div><canvas id="c_Fe" height="200"></canvas></div>
      <div><canvas id="c_Ca" height="200"></canvas></div>
      <div><canvas id="c_Na" height="200"></canvas></div>
      <div><canvas id="c_K" height="200"></canvas></div>
      <div><canvas id="c_Ti" height="200"></canvas></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
// === DATA (from MMHandout.xls) ===
const DEFAULT_INITIAL_CATIONS = { Si:184, Ti:5, Al:71, Fe:38, Mg:40, Ca:33, Na:23, K:6 };
let INITIAL_CATIONS = JSON.parse(JSON.stringify(DEFAULT_INITIAL_CATIONS));

const CRYSTALLIZATION = {
  "Fo":        [2,3,4,3,2,0,0,0,0,0],
  "Fa":        [0,0,1,1,1,1,0,0,0,0],
  "Di":        [0,0,0,1,1,4,2,2,1,1],
  "Anorthite": [0,1,2,3,3,4,3,3,1,1],
  "Albite":    [0,0,0,0,0,1,3,6,5,7],
  "K-spar":    [0,0,0,0,0,0,0,0,2,2],
  "Quartz":    [0,0,0,0,0,0,0,0,1,4],
  "Ilmenite":  [0,0,0,0,0,0,1,2,1,1],
  "Magnetite": [0,0,0,0,1,3,1,1,1,1]
};

const STOICH = {
  "Fo":        {Si:1, Mg:2},
  "Fa":        {Si:1, Fe:2},
  "Di":        {Si:2, Ca:1, Mg:1},
  "Anorthite": {Si:2, Al:2, Ca:1},
  "Albite":    {Si:3, Al:1, Na:1},
  "K-spar":    {Si:3, Al:1, K:1},
  "Quartz":    {Si:1},
  "Ilmenite":  {Fe:1, Ti:1},
  "Magnetite": {Fe:3}
};

const PRETTY_MINERAL = {
  "Fo":"Forsterite (Mg₂SiO₄)", "Fa":"Fayalite (Fe₂SiO₄)", "Di":"Diopside (CaMgSi₂O₆)",
  "Anorthite":"Anorthite (CaAl₂Si₂O₈)", "Albite":"Albite (NaAlSi₃O₈)", "K-spar":"K‑feldspar (KAlSi₃O₈)",
  "Quartz":"Quartz (SiO₂)", "Ilmenite":"Ilmenite (FeTiO₃)", "Magnetite":"Magnetite (Fe₃O₄)"
};

const ELEMENT_ORDER = ["Si","Al","Mg","Fe","Ca","Na","K","Ti"];
const MINERAL_ORDER = ["Fo","Fa","Di","Anorthite","Albite","K-spar","Quartz","Ilmenite","Magnetite"];

// Colors for magma visualizer
const MINERAL_COLORS = {
  Melt:'#2f81f7',
  Fo:'#7ee787',
  Fa:'#ffa657',
  Di:'#79c0ff',
  Anorthite:'#f2cc60',
  Albite:'#a5d6ff',
  'K-spar':'#ff7b72',
  Quartz:'#c9d1d9',
  Ilmenite:'#d29922',
  Magnetite:'#8b949e'
};

const CATION_COLORS = { Si:"#79c0ff", Al:"#ff7b72", Mg:"#d2a8ff", Fe:"#ffa657", Ca:"#7ee787", Na:"#a5d6ff", K:"#f2cc60", Ti:"#c9d1d9" };

function clone(obj){ return JSON.parse(JSON.stringify(obj)); }
function sumCations(melt){ return ELEMENT_ORDER.reduce((acc, el)=>acc + (melt[el] ?? 0), 0); }
function meltCompositionPct(melt){
  const tot = sumCations(melt);
  const out = {};
  for(const el of ELEMENT_ORDER){ out[el] = tot>0 ? (melt[el]/tot*100) : 0; }
  return out;
}
function mgNumber(melt){
  const mg = melt.Mg ?? 0, fe = melt.Fe ?? 0;
  return (mg+fe)>0 ? mg/(mg+fe) : 0;
}

// Apply one step with limiting reagents; track cations locked into each mineral.
function applyStepLimited(melt, step){
  const meltAfter = clone(melt);
  const removed = {}; for(const el of ELEMENT_ORDER) removed[el]=0;
  const actualMinerals = {}; const requestedMinerals = {};
  const lockedCationsByMineral = {}; // mineral -> total cations locked this step

  for(const mineral of MINERAL_ORDER){
    const reqUnits = (CRYSTALLIZATION[mineral]?.[step-1] ?? 0);
    requestedMinerals[mineral] = reqUnits;
    if(reqUnits <= 0){ actualMinerals[mineral]=0; lockedCationsByMineral[mineral]=0; continue; }

    const sto = STOICH[mineral] || {};
    let maxUnits = reqUnits;
    for(const el of Object.keys(sto)){
      const needPerUnit = sto[el];
      const available = meltAfter[el] ?? 0;
      const possible = needPerUnit>0 ? Math.floor(available / needPerUnit) : 0;
      if(possible < maxUnits) maxUnits = possible;
    }

    const act = Math.max(0, maxUnits);
    actualMinerals[mineral] = act;
    let locked = 0;
    if(act>0){
      for(const el of Object.keys(sto)){
        const delta = sto[el] * act;
        meltAfter[el] = (meltAfter[el] ?? 0) - delta;
        if(meltAfter[el] < 0) meltAfter[el] = 0;
        removed[el] += delta;
        locked += delta;
      }
    }
    lockedCationsByMineral[mineral] = locked;
  }

  return { meltAfter, removed, actualMinerals, requestedMinerals, lockedCationsByMineral };
}

function buildHistory(){
  const meltCounts = [clone(INITIAL_CATIONS)];
  const compPct = [meltCompositionPct(meltCounts[0])];
  const removedPct = [Object.fromEntries(ELEMENT_ORDER.map(e=>[e,0]))];
  const perStep = [{ actualMinerals:{}, requestedMinerals:{}, removed:Object.fromEntries(ELEMENT_ORDER.map(e=>[e,0])), lockedByMineral:{} }];

  // cumulative cations locked into minerals
  const cumLocked = Object.fromEntries(MINERAL_ORDER.map(m=>[m,0]));
  const magmaPartition = [ { Melt: sumCations(meltCounts[0]), ...clone(cumLocked) } ];

  let melt = clone(INITIAL_CATIONS);
  for(let s=1; s<=10; s++){
    const res = applyStepLimited(melt, s);
    melt = res.meltAfter;

    meltCounts.push(clone(melt));
    compPct.push(meltCompositionPct(melt));

    // step-wise crystallized % of initial
    const rp = {};
    for(const el of ELEMENT_ORDER){
      const denom = INITIAL_CATIONS[el] || 0;
      rp[el] = denom>0 ? (res.removed[el]/denom*100) : 0;
      rp[el] = Math.max(0, Math.min(100, rp[el]));
    }
    removedPct.push(rp);

    // store step
    perStep.push({
      actualMinerals: res.actualMinerals,
      requestedMinerals: res.requestedMinerals,
      removed: res.removed,
      lockedByMineral: res.lockedCationsByMineral
    });

    // update cumulative locked
    for(const m of MINERAL_ORDER){ cumLocked[m] += (res.lockedCationsByMineral[m] || 0); }
    magmaPartition.push({ Melt: sumCations(melt), ...clone(cumLocked) });
  }

  return { meltCounts, compPct, removedPct, perStep, magmaPartition };
}

function normalizedModesFromActual(stepInfo){
  const am = stepInfo.actualMinerals || {};
  const counts = { ol:0, pyx:0, plag:0, alk:0, qtz:0 };
  counts.ol = (am.Fo||0) + (am.Fa||0);
  counts.pyx = (am.Di||0);
  counts.plag = (am.Anorthite||0) + (am.Albite||0);
  counts.alk = (am["K-spar"]||0);
  counts.qtz = (am.Quartz||0);
  const total = counts.ol + counts.pyx + counts.plag + counts.alk + counts.qtz;
  const normalized = {};
  for(const k of Object.keys(counts)) normalized[k] = total>0 ? (counts[k]/total*100) : 0;
  return {counts, normalized, total};
}

// === UI refs ===
const stepSlider = document.getElementById("stepSlider");
const stepLabel  = document.getElementById("stepLabel");
const fLabel     = document.getElementById("fLabel");
const totalCations = document.getElementById("totalCations");
const mgNum        = document.getElementById("mgNum");
const tblRemoved = document.querySelector("#tblRemoved tbody");
const tblCounts  = document.querySelector("#tblCounts tbody");
const tblPct     = document.querySelector("#tblPct tbody");
const tblInit    = document.querySelector("#tblInit tbody");
const warnBox    = document.getElementById("warnBox");
const magmaBar   = document.getElementById("magmaBar");
const magmaLegend= document.getElementById("magmaLegend");

let currentStep = 0;
let maxUnlocked = 0;

// === Charts ===
let pieChart = null;
const cationCharts = {};

function ensureCharts(){
  if(!pieChart){
    pieChart = new Chart(document.getElementById('chartPie'), {
      type:'doughnut',
      data:{ labels:['ol','pyx','plag','alk','qtz'], datasets:[{ data:[0,0,0,0,0], backgroundColor:['#7ee787','#79c0ff','#f2cc60','#ff7b72','#c9d1d9'], borderColor:'#0b1220', borderWidth:1 }] },
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ labels:{ color:'#e6edf7' } } } }
    });
  }

  for(const el of ELEMENT_ORDER){
    if(cationCharts[el]) continue;
    cationCharts[el] = new Chart(document.getElementById(`c_${el}`), {
      type:'line',
      data:{ labels:[0], datasets:[] },
      options:{
        responsive:true,
        plugins:{ legend:{ labels:{ color:'#e6edf7' } }, title:{ display:true, text:`${el}: in melt vs crystallized`, color:'#e6edf7', font:{ size:12, weight:'600' } } },
        scales:{
          x:{ title:{ display:true, text:'Step', color:'#e6edf7' }, ticks:{ color:'#9fb0cc' }, grid:{ color:'#22304f' } },
          y:{ min:0, max:(el==='Si'?100:50), title:{ display:true, text:'Percent', color:'#e6edf7' }, ticks:{ color:'#9fb0cc' }, grid:{ color:'#22304f' } }
        }
      }
    });
  }
}

function buildInitInputs(){
  tblInit.innerHTML = '';
  for(const el of ELEMENT_ORDER){
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${el}</td><td><input type="number" min="0" step="1" id="init_${el}" value="${INITIAL_CATIONS[el] ?? 0}" /></td>`;
    tblInit.appendChild(tr);
  }
}

function applyInitialFromInputs(){
  const next = {};
  for(const el of ELEMENT_ORDER){
    const v = parseFloat(document.getElementById(`init_${el}`).value);
    next[el] = Number.isFinite(v) ? Math.max(0, v) : 0;
  }
  INITIAL_CATIONS = next;
  maxUnlocked = Math.min(maxUnlocked, currentStep);
  stepSlider.max = String(maxUnlocked);
  renderAll();
}

function updateTables(history){
  // minerals (actual vs requested)
  tblRemoved.innerHTML = '';
  if(currentStep===0){
    tblRemoved.innerHTML = `<tr><td class="muted">(none)</td><td class="muted">0</td><td class="muted">0</td></tr>`;
  } else {
    const info = history.perStep[currentStep];
    let any=false;
    for(const m of MINERAL_ORDER){
      const req = info.requestedMinerals[m] ?? 0;
      const act = info.actualMinerals[m] ?? 0;
      if(req>0 || act>0){
        any=true;
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${PRETTY_MINERAL[m]||m}</td><td>${act}</td><td class="muted">${req}</td>`;
        tblRemoved.appendChild(tr);
      }
    }
    if(!any) tblRemoved.innerHTML = `<tr><td class="muted">(none)</td><td class="muted">0</td><td class="muted">0</td></tr>`;
  }

  // cation counts
  tblCounts.innerHTML='';
  const melt = history.meltCounts[currentStep];
  for(const el of ELEMENT_ORDER){
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${el}</td><td>${(melt[el]??0).toFixed(2)}</td>`;
    tblCounts.appendChild(tr);
  }

  // melt %
  tblPct.innerHTML='';
  const pct = history.compPct[currentStep];
  for(const el of ELEMENT_ORDER){
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${el}</td><td>${pct[el].toFixed(2)}</td>`;
    tblPct.appendChild(tr);
  }
}

function updateKPIs(history){
  const melt = history.meltCounts[currentStep];
  const tot = sumCations(melt);
  totalCations.textContent = tot.toFixed(2);
  mgNum.textContent = mgNumber(melt).toFixed(3);
  stepLabel.textContent = String(currentStep);
  const initTot = sumCations(INITIAL_CATIONS);
  fLabel.textContent = (initTot>0 ? (tot/initTot) : 0).toFixed(3);
}

function updateMagmaVisualizer(history){
  const part = history.magmaPartition[currentStep];
  const initTot = sumCations(INITIAL_CATIONS) || 1;

  // Build segments in descending percent order (but always keep Melt first)
  const segments = [];
  segments.push({ key:'Melt', label:'Melt (liquid)', value:part.Melt, color:MINERAL_COLORS.Melt });
  for(const m of MINERAL_ORDER){
    segments.push({ key:m, label:PRETTY_MINERAL[m]||m, value:part[m]||0, color:MINERAL_COLORS[m]||'#8b949e' });
  }

  // Render bar
  magmaBar.innerHTML='';
  magmaLegend.innerHTML='';

  for(const seg of segments){
    const pct = (seg.value/initTot)*100;
    if(pct <= 0.0001) continue;
    const div=document.createElement('div');
    div.className='seg';
    div.style.width = `${pct}%`;
    div.style.background = seg.color;
    div.title = `${seg.label}: ${pct.toFixed(2)}% of total magma (cation basis)`;
    magmaBar.appendChild(div);

    const li=document.createElement('div');
    li.className='legitem';
    li.innerHTML = `<span class="swatch" style="background:${seg.color}"></span><span>${seg.label}</span><span style="margin-left:auto; color:#e6edf7;">${pct.toFixed(1)}%</span>`;
    magmaLegend.appendChild(li);
  }

  // Ensure sum ~100%: if rounding leaves a tiny gap, bar still OK.
}

function updateCharts(history){
  ensureCharts();

  // pie (current step)
  const modes = (currentStep===0) ? {normalized:{ol:0,pyx:0,plag:0,alk:0,qtz:0}} : normalizedModesFromActual(history.perStep[currentStep]);
  pieChart.data.datasets[0].data = ['ol','pyx','plag','alk','qtz'].map(k=>modes.normalized[k]);
  pieChart.update();

  // per-cation incremental plotting 0..currentStep
  const labels = Array.from({length: currentStep+1}, (_,i)=>i);
  for(const el of ELEMENT_ORDER){
    const meltLine = history.compPct.map(p=>p[el]).slice(0,currentStep+1);
    const crystLine = history.removedPct.map(p=>p[el]).slice(0,currentStep+1);

    const ch = cationCharts[el];
    ch.data.labels = labels;
    ch.data.datasets = [
      { label:'In melt (cation %)', data:meltLine, borderColor:CATION_COLORS[el]||'#fff', backgroundColor:CATION_COLORS[el]||'#fff', borderWidth:2, tension:0.2, pointRadius:(ctx)=> (ctx.dataIndex===currentStep ? 4 : 2) },
      { label:'Crystallized this step (% of initial)', data:crystLine, borderColor:'#9fb0cc', backgroundColor:'#9fb0cc', borderWidth:2, tension:0.2, borderDash:[6,4], pointRadius:(ctx)=> (ctx.dataIndex===currentStep ? 4 : 2) }
    ];
    ch.update();
  }
}

function renderAll(){
  const history = buildHistory();

  // warning if limiting activated
  let limitedSteps=[];
  for(let s=1; s<=10; s++){
    const info=history.perStep[s];
    for(const m of MINERAL_ORDER){
      const req=info.requestedMinerals[m]||0;
      const act=info.actualMinerals[m]||0;
      if(act < req){ limitedSteps.push(s); break; }
    }
  }
  limitedSteps=[...new Set(limitedSteps)];
  if(limitedSteps.length){
    warnBox.style.display='block';
    warnBox.innerHTML = `<b>Limiting reagents active:</b> at least one mineral could not fully crystallize in step(s): ${limitedSteps.join(', ')}.`;
  } else {
    warnBox.style.display='none';
  }

  updateTables(history);
  updateKPIs(history);
  updateMagmaVisualizer(history);
  updateCharts(history);
}

function setStep(step){
  if(step > maxUnlocked) step = maxUnlocked;
  if(step < 0) step = 0;
  currentStep = step;

  stepSlider.value = String(step);
  stepSlider.max = String(maxUnlocked);

  document.getElementById('btnPrev').disabled = (step===0);
  document.getElementById('btnNext').disabled = (step===10 || (maxUnlocked===10 && step===10));

  renderAll();
}

// === Navigation controls (no jump-ahead) ===
document.getElementById('btnPrev').onclick = ()=>setStep(currentStep-1);
document.getElementById('btnNext').onclick = ()=>{
  if(maxUnlocked < 10 && currentStep === maxUnlocked) maxUnlocked += 1;
  setStep(currentStep+1);
};
document.getElementById('btnResetStep').onclick = ()=>{ currentStep=0; maxUnlocked=0; setStep(0); };
stepSlider.oninput = (e)=>setStep(parseInt(e.target.value,10));

// Initial melt controls
document.getElementById('btnApplyInit').onclick = ()=>applyInitialFromInputs();
document.getElementById('btnResetInit').onclick = ()=>{ INITIAL_CATIONS = clone(DEFAULT_INITIAL_CATIONS); buildInitInputs(); maxUnlocked = Math.min(maxUnlocked, currentStep); stepSlider.max = String(maxUnlocked); renderAll(); };

// init
buildInitInputs();
setStep(0);
</script>
</body>
</html>
